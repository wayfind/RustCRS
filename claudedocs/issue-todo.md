# 待解决问题 (TODO Issues)

**更新时间**: 2025-11-03
**状态**: 🔴 待修复 / ⏸️ 暂缓

---

## 📋 使用说明

### 文件职责
- **本文件**: 记录所有待修复和暂缓的问题
- **issue-doing.md**: 问题开始修复时移动到该文件
- **issue-done.md**: 问题修复完成后移动到该文件

### 问题流转
```
issue-todo.md (待修复)
    → issue-doing.md (修复中)
        → issue-done.md (已完成)
```

### 根因分析核心原则
- ✅ **深入挖掘**: 追问 5 次"为什么"找到根本原因
- ✅ **识别依赖**: 明确问题之间的因果关系
- ✅ **优先底层**: 优先修复被多个问题依赖的底层问题
- ✅ **暂缓表层**: 依赖未解决的问题标记为 ⏸️ 暂缓

---

## 🌳 当前依赖树

> 维护问题间的依赖关系，识别关键路径

```
🏗️ 底层问题（优先修复）
暂无

✅ 独立问题（可立即修复）
暂无

✅ 已完成（批次 9-13）
├─ ISSUE-UI-004: GET /admin/tags 405错误 → ✅ 批次 9 已修复
├─ ISSUE-UI-005: 创建时间显示 Invalid Date → ✅ 批次 11 已修复
├─ ISSUE-UI-006: 标签未显示 → ✅ 批次 13 已修复
├─ ISSUE-UI-007: 编辑后名称未更新 → ✅ 批次 10 已修复
├─ ISSUE-UI-008: 删除操作未生效 → ✅ 批次 12 已修复
├─ ISSUE-UI-009: 编辑时404错误 → ✅ 批次 10 已修复
├─ ISSUE-UI-010: 创建后JS错误 → ✅ 批次 10 已修复
└─ ISSUE-UI-011: 添加账户404错误 → ✅ 批次 13 已修复

⏸️ 暂缓问题（等待依赖解决）
暂无
```

---

## 🔴 待修复问题 (Active Issues)

### 批次 6-11: [UI 深度测试发现的问题]

这是通过 Playwright 浏览器自动化进行的深度 UI 漫游测试发现的问题。测试覆盖了所有页面的所有交互元素。

**已完成问题**: ISSUE-UI-004, UI-005, UI-006, UI-007, UI-008, UI-009, UI-010, UI-011 (详见 issue-done.md)

**剩余问题**: 0 个

**状态**: ✅ 所有 UI 深度测试发现的问题已全部修复完成！

---

#### ~~ISSUE-UI-006 - 创建 API Key 时设置的标签未显示~~ ✅ 已修复

**优先级**: P2
**模块**: 管理后台/API Keys/标签功能
**状态**: ✅ 已修复 (批次 13)
**发现时间**: 2025-11-03
**修复时间**: 2025-11-03
**发现方式**: UI 深度漫游测试

**重现步骤**:
1. 创建新的 API Key
2. 在标签字段添加标签 "UI测试标签"
3. 提交创建
4. 查看创建成功的 API Key

**预期行为**:
- API Key 列表中显示 "UI测试标签"

**实际行为**:
- API Key 列表中显示 "无标签"

**🔍 根因分析**:
- **根本原因**: 标签数据未正确保存或未正确返回
  - 为什么 1: 前端创建时提交了标签，但列表中未显示
  - 为什么 2: 可能是保存到 Redis 时标签字段未处理
  - 为什么 3: 或者查询时标签字段未从 Redis 正确读取
  - 为什么 4: ApiKeyService 的标签处理逻辑可能不完整
  - 为什么 5: **标签功能的完整实现未完成（保存/读取/显示链路中断）**
- **根因类型**: 🔧 逻辑错误
- **依赖问题**: 无
- **阻塞问题**: 无
- **影响范围**: 标签分类功能完全不可用

**集成测试名称**: `test_api_key_tags_persistence`

**备注**:
- 需要检查 API Key 创建时的标签字段处理
- 需要检查列表查询时的标签字段返回

---

#### ~~ISSUE-UI-011 - 添加账户对话框打开时 404 错误~~ ✅ 已修复

**优先级**: P2
**模块**: 管理后台/账户管理/添加功能
**状态**: ✅ 已修复 (批次 13)
**发现时间**: 2025-11-03
**修复时间**: 2025-11-03
**发现方式**: UI 深度漫游测试

**重现步骤**:
1. 访问账户管理页面
2. 点击 "+ 添加账户" 按钮
3. 观察浏览器控制台

**预期行为**:
- 对话框正常打开
- 所有选项正确加载

**实际行为**:
- Console 错误: `API GET Error: Error: HTTP 404: Not Found`
- 对话框可以打开，但某些配置可能缺失

**错误信息**:
```
Failed to load resource: the server responded with a status of 404 (Not Found)
API GET Error: Error: HTTP 404: Not Found
```

**🔍 根因分析**:
- **根本原因**: 添加账户时需要的某个配置端点不存在
  - 为什么 1: 前端请求某个配置接口返回 404
  - 为什么 2: 可能是账户分组、平台配置等端点缺失
  - 为什么 3: 前端需要预加载某些选项列表
  - 为什么 4: 这些端点在迁移时未实现
  - 为什么 5: **账户管理相关的辅助配置端点未完整迁移**
- **根因类型**: 📚 缺失功能
- **依赖问题**: 无
- **阻塞问题**: 无
- **影响范围**:
  - 添加账户功能可以使用
  - 但某些高级选项可能不可用

**集成测试名称**: `test_account_configuration_endpoints`

**备注**:
- 需要识别具体缺失的端点（从控制台URL判断）
- 可能需要实现账户分组、平台配置等辅助端点

---

✅ 已完成批次 1-5 的所有问题修复！

批次 1 已完成：
├─ ✅ ISSUE-001: OEM设置端点公开访问
├─ ✅ ISSUE-003: 统计概览端点实现
└─ ✅ ISSUE-002: 前端OEM设置获取（自动解决）

批次 2 已完成：
├─ ✅ ISSUE-005: 使用成本统计端点实现
├─ ✅ ISSUE-006: 使用趋势端点实现
├─ ✅ ISSUE-007: 模型统计端点实现
├─ ✅ ISSUE-008: 账号使用趋势端点实现
└─ ✅ ISSUE-009: API Keys使用趋势端点实现

批次 3 已完成：
└─ ✅ ISSUE-010: 启动脚本非交互模式支持

批次 4 已完成：
├─ ✅ ISSUE-011: supported-clients 端点实现
├─ ✅ ISSUE-012: 8个账户类型管理端点（命名修复+占位）
└─ ✅ ISSUE-013: account-groups 端点占位实现

批次 5 已完成：
└─ ✅ ISSUE-004: 检查更新端点占位实现
```

### 修复优先级矩阵

**所有已知问题已修复完成！**

| 问题ID | 优先级 | 阻塞问题数 | 依赖问题数 | 批次 | 状态 |
|--------|--------|-----------|-----------|------|------|
| - | - | - | - | - | ✅ 无待修复问题 |

---

## 🎉 所有已知问题已修复

> **UI漫游测试发现的所有404错误已全部修复完成！**
>
> 共完成 13 个批次，修复 15 个问题（含自动解决的1个）
>
> 最新完成：批次 13 (2025-11-03) - ISSUE-UI-006 标签功能 + ISSUE-UI-011 版本端点

### 下一步建议

1. **深度测试**: 进行更全面的功能测试，可能会发现新问题
2. **完善占位实现**: 将占位端点实现完整功能（如统计聚合、GitHub版本检查等）
3. **集成测试**: 补充所有新端点的集成测试用例
4. **性能优化**: 对高频端点进行性能分析和优化
5. **文档更新**: 更新API文档，补充所有新增端点说明

---

## 📜 已归档问题（已移至 issue-done.md）

### 完成的批次总览

**批次 1**: OEM设置和统计概览（3个问题）
**批次 2**: Dashboard统计端点（5个问题）
**批次 3**: 启动脚本非交互模式（1个问题）
**批次 4**: API Keys & 账户管理核心功能（3个问题）
**批次 5**: 系统管理功能（1个问题）

---

## 🔄 已归档的问题详情

#### ISSUE-004 - 检查更新端点未实现 ✅

**优先级**: P2
**模块**: 管理后台/系统
**状态**: 🔴 待修复
**发现时间**: 2025-11-02
**发现方式**: UI 漫游测试

**重现步骤**:
1. 登录管理后台 http://localhost:8080/admin-next/dashboard
2. 观察浏览器控制台

**预期行为**:
- `/admin/check-updates` 返回版本信息或 HTTP 200

**实际行为**:
- 返回 HTTP 404 Not Found
- 前端显示错误: "Error checking for updates"

**错误信息**:
```
GET http://localhost:8080/admin/check-updates 404 (Not Found)
Error checking for updates: Error: HTTP 404: Not Found
```

**🔍 根因分析**:
- **根本原因**: 检查更新端点从未实现
  - 为什么 1: 前端请求 `/admin/check-updates` 失败
  - 为什么 2: Rust 后端没有该路由定义
  - 为什么 3: `admin.rs` 路由列表中未包含更新检查相关路由
  - 为什么 4: Node.js→Rust 迁移时该功能被标记为可选
  - 为什么 5: **版本更新检查功能不属于核心业务，迁移时优先级较低**
- **根因类型**: 📚 缺失功能
- **依赖问题**: 无
- **阻塞问题**: 无
- **影响范围**: 系统更新提醒功能不可用（不影响核心功能）

---

## 📜 已归档问题（已移至 issue-done.md）

#### ISSUE-001 - OEM设置端点缺少公开访问支持 ✅

**优先级**: P0
**模块**: 管理后台/认证
**状态**: 🔴 待修复
**发现时间**: 2025-11-02
**发现方式**: UI 漫游测试

**重现步骤**:
1. 访问 http://localhost:8080/admin-next（未登录状态）
2. 前端尝试获取 OEM 设置
3. 观察浏览器控制台错误

**预期行为**:
- OEM 设置应该可以公开访问（用于品牌化显示）
- 返回 HTTP 200 和设置数据

**实际行为**:
- 返回 HTTP 401 Unauthorized
- 前端无法显示品牌信息

**错误信息**:
```
GET http://localhost:8080/admin/oem-settings 401 (Unauthorized)
```

**相关接口**:
- `GET /admin/oem-settings`
- 响应: `HTTP 401`

**🔍 根因分析**:
- **根本原因**: OEM设置端点被JWT认证中间件保护，但前端需要在登录前访问
  - 为什么 1: 前端加载时立即请求 OEM 设置失败
  - 为什么 2: `/admin/oem-settings` 端点返回 401
  - 为什么 3: 所有 `/admin/*` 路由都应用了 JWT 认证中间件
  - 为什么 4: `create_admin_routes()` 在第146行对所有路由应用 `.layer(auth_layer(admin_service.clone()))`
  - 为什么 5: **架构设计未区分公开端点和受保护端点**，导致品牌化数据无法在登录前获取
- **根因类型**: 🏗️ 架构问题
- **依赖问题**: 无（可立即修复）
- **阻塞问题**:
  - 🚫 阻塞 ISSUE-002: 前端页面加载时OEM设置获取失败
- **影响范围**: 所有前端页面的品牌化显示

**技术分析**:
- 表面现象: 401 Unauthorized 错误
- 直接原因: JWT 中间件阻止未认证请求
- 底层原因: 路由架构未区分公开/受保护端点
- 涉及文件: `rust/src/routes/admin.rs:108-148`
- 设计缺陷: 第146行 `.layer()` 应用于所有路由

**修复计划**:
- [ ] 编写失败的集成测试（验证公开访问）
- [ ] 重构路由：将 OEM 设置移至公开路由组
- [ ] 验证测试通过
- [ ] 检查接口文档
- [ ] UI 回归测试
- [ ] 验证 ISSUE-002 是否可以解除

**备注**:
需要仔细设计公开路由组，避免暴露敏感端点

---

#### ISSUE-003 - 统计概览端点未实现

**优先级**: P1
**模块**: 管理后台/统计
**状态**: 🔴 待修复
**发现时间**: 2025-11-02
**发现方式**: UI 漫游测试

**重现步骤**:
1. 访问 http://localhost:8080/admin-next/api-stats
2. 前端请求统计数据
3. 观察 404 错误

**预期行为**:
- 返回 HTTP 200 和统计概览数据
- 前端显示统计图表

**实际行为**:
- 返回 HTTP 404 Not Found
- 前端显示"请求失败: 404"

**错误信息**:
```
GET http://localhost:8080/admin/stats/overview 404 (Not Found)
```

**相关接口**:
- `GET /admin/stats/overview` (不存在)

**🔍 根因分析**:
- **根本原因**: 统计概览端点从未实现
  - 为什么 1: 前端请求 `/admin/stats/overview` 失败
  - 为什么 2: Rust 后端没有该路由定义
  - 为什么 3: `admin.rs` 路由列表中未包含统计相关路由
  - 为什么 4: 后端重构时未迁移统计功能
  - 为什么 5: **Node.js→Rust 迁移遗漏了统计模块**
- **根因类型**: 📚 缺失功能
- **依赖问题**: 无
- **阻塞问题**: 无
- **影响范围**: API 统计页面完全不可用

**技术分析**:
- 表面现象: 404 Not Found
- 直接原因: 路由不存在
- 底层原因: 迁移计划中统计模块未实施
- 涉及文件: `rust/src/routes/admin.rs:108-148`
- 缺失内容: 统计查询逻辑、Redis 数据聚合

**修复计划**:
- [ ] 编写失败的集成测试
- [ ] 实现统计服务（StatsService）
- [ ] 添加 `/admin/stats/overview` 路由
- [ ] 验证测试通过
- [ ] 更新接口文档
- [ ] UI 回归测试

**备注**:
需要分析 Node.js 原实现以保持接口兼容性

---

### 批次 2: [独立功能问题]

这些问题相互独立，可以并行修复

---

## ⏸️ 暂缓问题 (Blocked/On Hold)

> 这些问题依赖其他未解决的问题，暂时无法修复

### ISSUE-002 - 前端页面加载时OEM设置获取失败

**优先级**: P2
**模块**: 前端/品牌化
**状态**: ⏸️ 暂缓
**暂缓原因**: 依赖 ISSUE-001 (OEM设置端点认证问题)
**暂缓时间**: 2025-11-02
**发现时间**: 2025-11-02
**发现方式**: UI 漫游测试

**依赖关系**:
```
ISSUE-002 (当前问题) ⏸️ 暂缓
  └─ 依赖 → ISSUE-001 (OEM设置端点认证) 🔴 待修复
```

**恢复条件**:
- [ ] ISSUE-001 已修复（OEM 设置可公开访问）
- [ ] 集成测试验证公开访问正常
- [ ] 前端可以在未登录状态获取品牌信息

**重现步骤**:
1. 清除浏览器会话
2. 访问 http://localhost:8080/admin-next
3. 观察品牌信息显示

**预期行为**:
- 页面显示自定义品牌名称和logo
- 无认证错误

**实际行为**:
- 浏览器控制台显示 401 错误
- 品牌信息缺失或显示默认值

**🔍 根因分析**:
- **根本原因**: 前端依赖后端提供公开访问的 OEM 设置端点
- **根因类型**: 🔌 接口不一致（前端预期公开，后端要求认证）
- **依赖问题**:
  - ⏸️ 依赖 ISSUE-001: OEM设置端点需要移至公开路由组
- **为何暂缓**: 必须先修复后端路由架构，否则前端无法获取数据

**备注**:
ISSUE-001 修复后，此问题应自动解决，只需验证

---

## 📊 统计信息

**总待修复**: 2 个
- 🔴 可立即修复: 2 个 (P2 × 2)
- ⏸️ 暂缓中: 0 个

**已完成**: 6 个问题 (批次 9-12)
- ✅ ISSUE-UI-004 (P1) - GET /admin/tags 405 → 批次 9 已修复
- ✅ ISSUE-UI-005 (P2) - Invalid Date 显示 → 批次 11 已修复
- ✅ ISSUE-UI-007 (P2) - 编辑后名称未更新 → 批次 10 已修复
- ✅ ISSUE-UI-008 (P0) - 删除操作未生效 → 批次 12 已修复
- ✅ ISSUE-UI-009 (P2) - 编辑时 404 错误 → 批次 10 已修复
- ✅ ISSUE-UI-010 (P2) - 创建后 JS 错误 → 批次 10 已修复

**依赖树统计**:
- 底层问题（被多个问题依赖）: 0 个
- 独立问题（无依赖关系）: 2 个
- 所有 P0 (关键) 问题已解决 ✅

**推荐修复顺序**:
1. **批次 13 (建议)**:
   - ISSUE-UI-006 (P2) - 标签未显示在列表中
   - ISSUE-UI-011 (P2) - 添加账户时 404 错误

---

## 📝 问题记录模板

复制以下模板记录新问题：

```markdown
#### ISSUE-XXX - [问题标题]

**优先级**: P0/P1/P2/P3
**模块**: [模块名称]
**状态**: 🔴 待修复 / ⏸️ 暂缓
**发现时间**: YYYY-MM-DD
**发现方式**: UI 漫游测试/集成测试/用户反馈

**重现步骤**:
1.
2.
3.

**预期行为**:
-

**实际行为**:
-

**错误信息**:
```
[错误信息]
```

**相关接口**:
- `METHOD /path`

**🔍 根因分析** (必填！):
- **根本原因**: [深入分析：追问 5 次为什么]
  - 为什么 1:
  - 为什么 2:
  - 为什么 3:
  - 为什么 4:
  - 为什么 5:
- **根因类型**: 🔧/🏗️/📊/🔌/⚡/🔒/📚
- **依赖问题**:
  - ⏸️ 依赖 ISSUE-XXX: [描述] (如果有)
  - ⏸️ 依赖特性: [描述] (如果有)
- **阻塞问题**:
  - 🚫 阻塞 ISSUE-YYY: [描述] (如果有)
- **影响范围**: [功能和模块]

**技术分析**:
- 表面现象:
- 直接原因:
- 底层原因:
- 涉及文件:
- Redis 数据:

**修复计划**:
- [ ] 检查依赖（如有依赖，标记⏸️暂缓）
- [ ] 编写失败的集成测试
- [ ] 修复 Rust 代码
- [ ] 验证测试通过
- [ ] 检查接口文档
- [ ] UI 回归测试
- [ ] 验证被阻塞问题是否可以解除

**备注**:
```

---

## 🚀 快速操作

### 记录新问题
1. 复制问题模板
2. 填写基本信息
3. **进行根因分析**（追问 5 次为什么）
4. 识别依赖关系和阻塞关系
5. 如果有依赖：标记 ⏸️ 暂缓，放入"暂缓问题"部分
6. 如果无依赖：标记 🔴 待修复，放入"待修复问题"部分
7. 更新依赖树可视化
8. 更新统计信息

### 选择问题开始修复
1. **优先选择底层问题**（阻塞问题数多）
2. 选择 ≤5 个相关问题组成批次
3. 确认所有问题都无未解决的依赖
4. **移动问题到 issue-doing.md**
5. 在该文件中删除已移动的问题
6. 更新统计信息

### 暂缓问题恢复
1. 定期检查暂缓问题的依赖状态
2. 依赖问题在 issue-done.md 中标记完成后
3. 将暂缓问题移至"待修复问题"部分
4. 更新依赖树和恢复条件
5. 重新评估优先级和批次

---

## 📚 参考资源

- **CLAUDE.md**: 项目工作流程和开发指南
- **issue-doing.md**: 正在修复的问题
- **issue-done.md**: 已完成的问题
- **docs/guides/api-reference.md**: 接口文档
- **docs/architecture/testing.md**: 测试指南

---

**维护说明**:
- 发现新问题时立即记录到本文件
- 开始修复时移动到 issue-doing.md
- 完成修复后由 issue-doing.md 移至 issue-done.md
- 定期检查暂缓问题的依赖状态
- 持续更新依赖树和统计信息

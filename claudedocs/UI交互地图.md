# Claude Relay Service - UI 交互地图

**文档版本**: 1.0
**测试日期**: 2025-11-03
**测试环境**: Rust 后端 + Vue 3 前端
**基础URL**: http://localhost:8080/admin-next

---

## 📋 文档说明

本文档记录了管理后台所有页面的状态、交互元素和发现的问题，用于指导全面的UI测试。

---

## 🗺️ 页面导航结构

```
Claude Relay Service 管理后台
├── 登录页 (/admin-next) → 自动重定向到 /api-stats
├── API Key 统计查询 (/api-stats)
└── 管理后台 (/admin-next/dashboard)
    ├── 仪表板 (/dashboard)
    ├── API Keys (/api-keys)
    ├── 账户管理 (/accounts)
    ├── 使用教程 (/tutorial)
    └── 系统设置 (/settings)
```

---

## 1️⃣ 登录页 / API Key 统计查询

### 页面信息
- **URL**: `http://localhost:8080/admin-next` → 自动跳转到 `/api-stats`
- **页面标题**: "API Key 使用统计"
- **功能**: 公开的API Key使用统计查询页面

### 交互元素

#### 1.1 导航栏
| 元素 | 类型 | 功能 | 状态 |
|------|------|------|------|
| 主题切换按钮 | Button | 切换明暗主题 | ✅ 正常 |
| "管理后台" 链接 | Link | 跳转到管理后台登录 | ✅ 正常 |

#### 1.2 Tab 导航
| Tab | 功能 | 状态 |
|-----|------|------|
| 统计查询 | 查询API Key使用统计 | ✅ 激活状态 |
| 使用教程 | 查看客户端使用教程 | ✅ 正常 |

#### 1.3 查询表单
| 元素 | 类型 | 必填 | 默认值 | 验证规则 |
|------|------|------|--------|----------|
| API Key 输入框 | TextBox | 是 | 空 | cr_开头的格式 |
| 查询类型 | ButtonGroup | - | "单一" | 单一/聚合 |
| 查询统计按钮 | Button | - | 禁用 | 输入有效后启用 |

### 发现的问题
无

---

## 2️⃣ 仪表板页面 (Dashboard)

### 页面信息
- **URL**: `/admin-next/dashboard`
- **页面标题**: "仪表板"
- **功能**: 显示系统整体统计信息和实时数据

### 交互元素

#### 2.1 顶部导航
| 元素 | 类型 | 功能 |
|------|------|------|
| Claude Relay Service 标题 | Heading | 品牌标识 |
| v2.0.0 版本号 | Text | 版本信息 |
| 主题切换按钮 | Button | 明暗主题切换 |
| Admin 下拉菜单 | Dropdown | 用户菜单 |

#### 2.2 侧边导航
| 导航项 | 目标URL | 状态 |
|--------|---------|------|
| 仪表板 | /dashboard | 当前页 |
| API Keys | /api-keys | ✅ 正常 |
| 账户管理 | /accounts | ✅ 正常 |
| 使用教程 | /tutorial | ✅ 正常 |
| 系统设置 | /settings | ✅ 正常 |

#### 2.3 数据展示区域
- **预期**: 统计卡片、图表、实时数据
- **实际**: 空白（JavaScript错误导致渲染失败）

### 发现的问题

#### 🔴 ISSUE-UI-003: Dashboard 数据字段名不匹配
- **优先级**: P0 (阻塞)
- **症状**:
  - Console 错误: `Cannot read properties of undefined (reading 'overview')`
  - Console 错误: `Cannot read properties of undefined (reading 'length')`
  - 页面主内容区域完全空白
- **根因**:
  - 后端返回: `{success: true, stats: {...}}`
  - 前端期望: `{success: true, data: {overview: {...}}}`
- **影响**: Dashboard 页面完全不可用
- **位置**:
  - 后端: `rust/src/routes/admin.rs:284-320`
  - 前端: `web/admin-spa/src/stores/dashboard.js:165`

---

## 3️⃣ API Keys 管理页面

### 页面信息
- **URL**: `/admin-next/api-keys`
- **页面标题**: "API Keys 管理"
- **功能**: 管理和监控API密钥

### 交互元素

#### 3.1 Tab 切换
| Tab | 功能 | 数据来源 |
|-----|------|----------|
| 活跃 API Keys | 显示未删除的Key | GET /admin/api-keys |
| 已删除 API Keys | 显示已删除的Key | GET /admin/api-keys?deleted=true |

#### 3.2 筛选和搜索工具栏
| 元素 | 类型 | 功能 | 状态 |
|------|------|------|------|
| 时间筛选下拉框 | Dropdown | 按时间筛选 | ✅ 正常 |
| 标签筛选下拉框 | Dropdown | 按标签筛选 | ⚠️ 有错误 |
| 搜索方式下拉框 | Dropdown | 选择搜索字段 | ✅ 正常 |
| 搜索输入框 | TextBox | 输入搜索关键词 | ✅ 正常 |

#### 3.3 操作按钮
| 按钮 | 功能 | 状态 |
|------|------|------|
| 刷新 | 重新加载列表 | ✅ 正常 |
| 选择 | 批量选择操作 | ✅ 正常 |
| 导出数据 | 导出为CSV/Excel | ✅ 正常 |
| + 创建新 Key | 打开创建对话框 | ✅ 正常 |

#### 3.4 数据表格列
| 列名 | 可排序 | 数据类型 |
|------|--------|----------|
| 名称 | ✅ | Text |
| 所属账号 | ❌ | Text |
| 标签 | ❌ | Badge |
| 状态 | ✅ | Badge |
| 费用 | ✅ | Currency |
| 限制 | ❌ | Text |
| Token | ✅ | Number |
| 请求数 | ✅ | Number |
| 最后使用 | ✅ | DateTime |
| 创建时间 | ✅ | DateTime |
| 过期时间 | ✅ | DateTime |
| 操作 | ❌ | Actions |

#### 3.5 行操作按钮
| 按钮 | 功能 | 对话框 | 状态 |
|------|------|--------|------|
| 详情 | 查看使用统计 | 统计详情对话框 | ✅ 正常 |
| 模型 | 管理模型限制 | 模型限制对话框 | ✅ 正常 |
| 编辑 | 编辑Key配置 | 编辑对话框 | ⚠️ 有错误 |
| 激活/禁用 | 切换Key状态 | 确认对话框 | ✅ 正常 |
| 删除 | 软删除Key | 确认对话框 | ⚠️ 有问题 |

### 3.6 创建 API Key 对话框

#### 对话框信息
- **标题**: "创建新的 API Key"
- **步骤**: 单步表单
- **提交**: POST /admin/api-keys

#### 表单字段

##### 基本信息
| 字段 | 类型 | 必填 | 默认值 | 测试值 |
|------|------|------|--------|--------|
| 创建类型 | Radio | ✅ | 单个创建 | 单个创建/批量创建 |
| 名称 | TextBox | ✅ | 空 | "测试创建API Key UI测试" |
| 标签 | TagInput | ❌ | 空 | "UI测试标签" |

##### 速率限制设置
| 字段 | 类型 | 必填 | 默认值 | 测试值 |
|------|------|------|--------|--------|
| 时间窗口(分钟) | Number | ❌ | 0 | 60 |
| 请求次数限制 | Number | ❌ | 0 | 1000 |
| 费用限制(美元) | Number | ❌ | 0 | 10 |

##### 费用限制
| 字段 | 类型 | 快捷按钮 | 测试值 |
|------|------|----------|--------|
| 每日费用限制 | Number | $50/$100/$200/自定义 | $50 |
| 总费用限制 | Number | $100/$500/$1000/自定义 | $500 |
| Opus周费用限制 | Number | $100/$500/$1000/自定义 | - |

##### 其他设置
| 字段 | 类型 | 默认值 | 测试值 |
|------|------|--------|--------|
| 并发限制 | Number | 0 | 5 |
| 备注 | TextArea | 空 | "这是UI深度测试..." |
| 过期设置 | Dropdown | 永不过期 | 7天 |
| 服务权限 | Radio | 全部服务 | 仅 Claude |

##### 高级选项
| 字段 | 类型 | 功能 | 测试结果 |
|------|------|------|----------|
| 专属账号绑定 | Dropdown | 绑定特定账户 | ✅ 正常 |
| 启用模型限制 | Checkbox | 开启后显示模型列表 | ✅ 正常 |
| 模型限制列表 | TagInput | 添加禁用模型 | ✅ 正常 |
| 启用客户端限制 | Checkbox | 开启后显示客户端列表 | ✅ 正常 |
| 允许的客户端 | CheckboxGroup | 选择允许的客户端 | ✅ 正常 |

#### 对话框操作按钮
| 按钮 | 功能 | 状态 |
|------|------|------|
| 取消 | 关闭对话框 | ✅ 正常 |
| + 创建 | 提交创建请求 | ✅ 正常 |

### 3.7 编辑 API Key 对话框

#### 对话框信息
- **标题**: "编辑 API Key"
- **加载**: GET /admin/api-keys/:id (获取详情)
- **提交**: PUT /admin/api-keys/:id

#### 表单字段
- **字段列表**: 与创建对话框基本相同
- **额外字段**:
  - 所有者选择 (Dropdown)
  - 激活账号 (Checkbox)

#### 对话框操作按钮
| 按钮 | 功能 | 状态 |
|------|------|------|
| 取消 | 关闭对话框 | ✅ 正常 |
| 保存修改 | 提交更新请求 | ⚠️ 有问题 |

### 3.8 统计详情对话框

#### 对话框信息
- **标题**: "使用统计详情 - {Key名称}"
- **数据来源**: GET /admin/api-keys/:id/stats

#### 统计卡片
| 卡片 | 指标 | 状态 |
|------|------|------|
| 总请求数 | requests, 今日requests | ✅ 正常 |
| 总Token数 | total_tokens, 今日tokens | ✅ 正常 |
| 总费用 | total_cost, 今日cost | ✅ 正常 |
| 平均速率 | RPM, TPM | ✅ 正常 |
| Token分布 | input/output tokens | ✅ 正常 |

### 发现的问题

#### 🔴 ISSUE-UI-004: GET /admin/tags 返回 405 Method Not Allowed
- **优先级**: P1
- **触发**: 打开创建/编辑对话框时
- **错误信息**: `API GET Error: Error: HTTP 405: Method Not Allowed`
- **影响**: 标签下拉列表无法加载已有标签
- **API位置**: GET /admin/tags

#### 🟡 ISSUE-UI-005: API Key 创建时间显示 "Invalid Date"
- **优先级**: P2
- **位置**: API Keys 列表表格的"创建时间"列
- **症状**: 所有API Key的创建时间都显示为 "Invalid Date"
- **可能原因**: 日期格式化问题或后端返回的日期格式不正确

#### 🟡 ISSUE-UI-006: 创建时设置的标签未显示
- **优先级**: P2
- **复现步骤**:
  1. 创建API Key时添加标签"UI测试标签"
  2. 创建成功
  3. 列表中显示"无标签"
- **影响**: 标签功能不可用

#### 🟡 ISSUE-UI-007: 编辑后名称未更新
- **优先级**: P2
- **复现步骤**:
  1. 编辑API Key，修改名称为"xxx - 已编辑"
  2. 保存成功（显示"API Key 更新成功"）
  3. 列表中名称仍为旧名称
- **影响**: 编辑功能视觉反馈不正确

#### 🔴 ISSUE-UI-008: 删除操作未生效
- **优先级**: P0
- **复现步骤**:
  1. 点击删除按钮
  2. 确认删除
  3. 显示"API Key 已删除"
  4. 列表中仍然显示该Key
- **影响**: 删除功能完全失效

#### 🟡 ISSUE-UI-009: 编辑对话框加载时 404 错误
- **优先级**: P2
- **错误**: `API GET Error: Error: HTTP 404: Not Found`
- **触发**: 点击"编辑"按钮时
- **影响**: 可能无法加载Key的完整配置信息

#### 🟡 ISSUE-UI-010: JavaScript错误 "Cannot read properties of undefined (reading 'name')"
- **优先级**: P2
- **触发**: 创建API Key成功后
- **位置**: Console错误
- **影响**: 可能影响某些字段的显示

---

## 4️⃣ 账户管理页面

### 页面信息
- **URL**: `/admin-next/accounts`
- **页面标题**: "账户管理"
- **功能**: 管理 Claude、Gemini、OpenAI 等账户与代理配置

### 交互元素

#### 4.1 工具栏
| 元素 | 类型 | 功能 | 状态 |
|------|------|------|------|
| 排序方式 | Dropdown | 按名称/时间排序 | ✅ 正常 |
| 平台筛选 | Dropdown | 筛选特定平台 | ✅ 正常 |
| 账户类型筛选 | Dropdown | 共享/专属/分组 | ✅ 正常 |
| 搜索框 | TextBox | 搜索账户名称 | ✅ 正常 |
| 刷新按钮 | Button | 重新加载列表 | ✅ 正常 |
| 选择按钮 | Button | 批量选择 | ✅ 正常 |
| + 添加账户 | Button | 打开添加对话框 | ✅ 正常 |

#### 4.2 空状态
| 元素 | 内容 |
|------|------|
| 图标 | 📭 |
| 提示文字 | "暂无账户" |
| 说明文字 | "点击上方按钮添加您的第一个账户" |

### 4.3 添加账户对话框

#### 对话框信息
- **标题**: "添加账户"
- **步骤**: 两步流程
  1. 基本信息
  2. 授权认证
- **提交**: POST /admin/claude-accounts 或其他平台端点

#### 步骤1: 基本信息

##### 平台选择
| 平台 | 图标 | 描述 | 子类型 |
|------|------|------|--------|
| Claude | 🤖 | Anthropic | Claude Code官方/Console/Bedrock/CCR |
| OpenAI | 🔷 | GPT系列 | - |
| Gemini | 🌟 | Google AI | - |
| Droid | 🤖 | Claude Droid | - |

##### 添加方式 (Claude平台)
| 方式 | 说明 | 优点 |
|------|------|------|
| OAuth 授权 | 官方授权流程 | 用量可视化 |
| Setup Token | 长期有效Token | 效期长 |
| 手动输入 Access Token | 直接输入Token | 快速配置 |

##### 基本字段
| 字段 | 类型 | 必填 | 默认值 | 测试值 |
|------|------|------|--------|--------|
| 账户名称 | TextBox | ✅ | 空 | "UI测试Claude账户" |
| 描述 | TextArea | ❌ | 空 | "用于UI深度测试的Claude账户" |
| 账户类型 | Radio | ✅ | 共享账户 | 共享/专属/分组调度 |
| 到期时间 | Dropdown | ❌ | 永不过期 | 永不过期/30天/90天/... |
| 订阅类型 | Radio | ✅ | Claude Max | Claude Max/Pro |

##### 高级选项
| 选项 | 类型 | 默认值 | 功能 |
|------|------|--------|------|
| 5小时限制自动停止 | Checkbox | false | 防止超限 |
| 使用统一Claude Code版本 | Checkbox | false | 统一User-Agent |
| 使用统一客户端标识 | Checkbox | false | 固定客户端标识 |
| 调度优先级 | Number | 50 | 1-100数字 |

##### 代理设置
| 字段 | 类型 | 默认值 | 测试值 |
|------|------|--------|--------|
| 启用代理 | Checkbox | false | true (展开设置) |
| 快速配置URL | TextBox | 空 | socks5://... |
| 代理类型 | Dropdown | SOCKS5 | SOCKS5/HTTP/HTTPS |
| 主机地址 | TextBox | 空 | 192.168.1.100 |
| 端口 | Number | 空 | 1080 |
| 需要身份验证 | Checkbox | false | - |

#### 步骤2: 授权认证
- **OAuth方式**: 生成授权URL → 用户授权 → 输入授权码
- **Token方式**: 直接输入Token

#### 对话框操作按钮
| 步骤 | 按钮 | 功能 |
|------|------|------|
| 步骤1 | 取消 | 关闭对话框 |
| 步骤1 | 下一步 | 进入步骤2 |
| 步骤2 | 上一步 | 返回步骤1 |
| 步骤2 | 完成 | 提交创建 |

### 发现的问题

#### 🟡 ISSUE-UI-011: 添加账户对话框打开时 404 错误
- **优先级**: P2
- **错误**: `API GET Error: Error: HTTP 404: Not Found`
- **触发**: 点击"+ 添加账户"按钮
- **影响**: 可能无法加载某些配置选项

---

## 5️⃣ 使用教程页面

### 页面信息
- **URL**: `/admin-next/tutorial`
- **页面标题**: "Claude Code 使用教程"
- **功能**: 提供客户端安装和配置指南

### 交互元素

#### 5.1 平台切换Tab
| Tab | 内容 | 状态 |
|-----|------|------|
| Windows | Windows安装教程 | ✅ 正常 |
| macOS | macOS安装教程 | ✅ 正常 |
| Linux / WSL2 | Linux安装教程 | ✅ 正常 |

#### 5.2 教程章节

##### 第1步: 安装 Node.js 环境
- 官网下载方法
- 包管理器安装方法
- 验证安装命令

##### 第2步: 安装 Claude Code
- npm 全局安装命令
- 验证安装命令

##### 第3步: 设置环境变量
###### Claude Code 配置
- PowerShell 临时设置
- PowerShell 永久设置
- VSCode 插件配置
- 验证环境变量

###### Gemini CLI 配置
- 环境变量设置
- 验证命令

###### Codex 配置
- config.toml 配置
- auth.json 配置

###### Droid CLI 配置
- config.json 配置

##### 第4步: 开始使用
- 启动命令
- 项目中使用

##### Windows 常见问题
- 权限问题
- PowerShell 执行策略
- 环境变量不生效

#### 5.3 交互元素
| 元素 | 类型 | 功能 |
|------|------|------|
| 代码块 | Code | 可复制的命令 |
| 折叠面板 | Accordion | 常见问题折叠 |

### 发现的问题
无

---

## 6️⃣ 系统设置页面

### 页面信息
- **URL**: `/admin-next/settings`
- **页面标题**: "系统设置"
- **功能**: 网站定制和通知配置

### 交互元素

#### 6.1 设置Tab
| Tab | 功能 | 状态 |
|-----|------|------|
| 品牌设置 | 自定义网站外观 | ✅ 当前页 |
| 通知设置 | 配置通知方式 | ✅ 正常 |

#### 6.2 品牌设置表单
| 设置项 | 类型 | 默认值 | 功能 |
|--------|------|--------|------|
| 网站名称 | TextBox | Claude Relay Service | 浏览器标题 |
| 网站图标 | FileUpload | - | Favicon上传 |
| 管理入口显示 | Checkbox | true | 显示登录按钮 |

#### 6.3 操作按钮
| 按钮 | 功能 | API |
|------|------|-----|
| 保存设置 | 保存所有更改 | PUT /admin/settings |
| 重置为默认 | 恢复默认设置 | - |

### 发现的问题
无

---

## 📊 问题汇总表

| ID | 优先级 | 页面 | 问题描述 | 状态 |
|----|--------|------|----------|------|
| ISSUE-UI-003 | P0 | Dashboard | 数据字段名不匹配，页面空白 | 🔴 待修复 |
| ISSUE-UI-004 | P1 | API Keys | GET /admin/tags 405错误 | 🔴 待修复 |
| ISSUE-UI-005 | P2 | API Keys | 创建时间显示 Invalid Date | 🟡 待修复 |
| ISSUE-UI-006 | P2 | API Keys | 创建时设置的标签未显示 | 🟡 待修复 |
| ISSUE-UI-007 | P2 | API Keys | 编辑后名称未更新 | 🟡 待修复 |
| ISSUE-UI-008 | P0 | API Keys | 删除操作未生效 | 🔴 待修复 |
| ISSUE-UI-009 | P2 | API Keys | 编辑时404错误 | 🟡 待修复 |
| ISSUE-UI-010 | P2 | API Keys | JavaScript 'name' undefined错误 | 🟡 待修复 |
| ISSUE-UI-011 | P2 | 账户管理 | 添加账户时404错误 | 🟡 待修复 |

### 优先级定义
- **P0** (阻塞): 核心功能完全失效，必须立即修复
- **P1** (高): 重要功能受影响，需要尽快修复
- **P2** (中): 功能可用但体验不佳，计划修复
- **P3** (低): 小问题或优化项，有时间再修复

---

## 🧪 测试覆盖度总结

### 已测试功能
✅ **Dashboard 页面**: 导航和布局测试
✅ **API Keys 页面**: 完整CRUD流程测试
✅ **账户管理页面**: 创建流程部分测试
✅ **使用教程页面**: 内容显示测试
✅ **系统设置页面**: 表单显示测试

### 未完整测试的功能
⚠️ **API Keys**:
- 批量创建功能
- 导出数据功能
- 模型限制对话框
- 已删除Tab的恢复功能

⚠️ **账户管理**:
- OAuth授权流程
- 编辑账户功能
- 删除账户功能
- 账户分组功能

⚠️ **系统设置**:
- 通知设置Tab
- 文件上传功能
- 设置保存和恢复

---

## 🔄 UI测试检查清单

### 每次UI测试应验证的项目

#### 基础功能
- [ ] 所有页面能正常加载（无白屏）
- [ ] 导航栏所有链接可点击且跳转正确
- [ ] 主题切换功能正常（明暗模式）
- [ ] 所有表单提交后有成功/失败提示

#### API Keys 页面
- [ ] 列表正常显示数据
- [ ] 创建功能：所有字段可填写，提交成功
- [ ] 编辑功能：数据正确回显，保存成功
- [ ] 删除功能：确认对话框显示，删除生效
- [ ] 详情对话框：统计数据正确显示
- [ ] 筛选和搜索：结果正确

#### 账户管理页面
- [ ] 平台选择：所有平台可选
- [ ] 添加流程：两步流程完整可用
- [ ] 代理设置：展开/折叠正常
- [ ] 表单验证：必填项验证生效

#### 数据一致性
- [ ] 创建后列表立即更新
- [ ] 编辑后数据正确反映
- [ ] 删除后列表立即移除
- [ ] 刷新后数据保持一致

#### Console 检查
- [ ] 无 JavaScript 错误
- [ ] 无 404/405 等HTTP错误
- [ ] 无数据结构不匹配错误

---

## 📝 测试注意事项

### 测试前准备
1. 确保 Redis 服务运行
2. 确保 Rust 后端服务启动 (端口8080)
3. 清除浏览器缓存和 LocalStorage
4. 使用最新的前端构建版本

### 测试环境
- **浏览器**: Chrome/Edge (最新版本)
- **分辨率**: 1920x1080 或以上
- **网络**: localhost (无延迟)

### 数据准备
- 至少创建1个管理员账户
- 准备测试用的 API Key
- 准备测试用的账户配置

### 测试方法
1. **系统性测试**: 按页面顺序逐个测试
2. **功能性测试**: 每个按钮、表单都要点击/填写
3. **边界测试**: 空值、超长值、特殊字符
4. **回归测试**: 修复问题后重新验证整个流程

---

## 📚 相关文档

- **API 接口文档**: `docs/guides/api-reference.md`
- **问题追踪**: `claudedocs/issue-todo.md`
- **架构说明**: `CLAUDE.md`
- **测试指南**: `docs/architecture/testing.md`

---

**文档维护**: 每次UI测试后更新本文档，记录新发现的问题和已修复的功能。

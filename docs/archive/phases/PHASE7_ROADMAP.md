# Phase 7 å®æ–½è·¯çº¿å›¾ - ç»Ÿè®¡å’Œé™æµç³»ç»Ÿ

**åˆ›å»ºæ—¶é—´**: 2025-10-31
**é¢„æœŸå®Œæˆæ—¶é—´**: 1-2 å‘¨
**ä¼˜å…ˆçº§**: P0 (é«˜ä¼˜å…ˆçº§)
**çŠ¶æ€**: ğŸ“‹ è§„åˆ’ä¸­

---

## ğŸ“Š Phase 7 æ¦‚è§ˆ

Phase 7 å°†å®Œå–„ç°æœ‰çš„ç»Ÿè®¡å’Œé™æµåŸºç¡€è®¾æ–½ï¼Œå®ç°ç”Ÿäº§çº§çš„ä½¿ç”¨ç›‘æ§å’Œæˆæœ¬æ§åˆ¶ç³»ç»Ÿã€‚

### æ ¸å¿ƒç›®æ ‡

1. âœ… **ç»Ÿè®¡æœåŠ¡å®Œå–„** - å®Œæ•´çš„ä½¿ç”¨ç»Ÿè®¡å’Œæˆæœ¬è¿½è¸ª
2. âœ… **é€Ÿç‡é™åˆ¶å®ç°** - çœŸå®çš„é™æµæ‰§è¡Œå’Œå¹¶å‘æ§åˆ¶
3. âœ… **å®æ—¶æŒ‡æ ‡æ”¶é›†** - å¤šç»´åº¦ç»Ÿè®¡å’Œç›‘æ§
4. â³ **OpenAI è½¬å‘å®Œå–„** - å®Œæˆè½¬å‘æœåŠ¡å®ç°

---

## ğŸ¯ Phase 7.1: ç»Ÿè®¡æœåŠ¡å®Œå–„

### å½“å‰çŠ¶æ€åˆ†æ

**å·²å­˜åœ¨çš„åŸºç¡€è®¾æ–½**:
- âœ… `src/services/pricing_service.rs` - å®Œæ•´çš„å®šä»·æœåŠ¡
  - æ¨¡å‹å®šä»·æ•°æ®ç®¡ç†
  - æˆæœ¬è®¡ç®—å¼•æ“
  - è¿œç¨‹æ•°æ®æ›´æ–°
  - æœ¬åœ°ç¼“å­˜å’Œ fallback
- âœ… `src/utils/cost_calculator.rs` - æˆæœ¬è®¡ç®—å·¥å…·
- âœ… `src/services/api_key.rs` - åŸºç¡€ç»Ÿè®¡è®°å½•
  - `update_usage_stats()` æ–¹æ³•
  - `get_usage_stats()` æ–¹æ³•
  - Redis å­˜å‚¨ç»“æ„

**å¾…å®Œå–„åŠŸèƒ½**:

#### 1.1 æˆæœ¬è®¡ç®—é›†æˆ (P0)
**é¢„æœŸæ—¶é—´**: 1 å¤©
**æ–‡ä»¶**: `src/routes/api.rs`, `src/routes/gemini.rs`, `src/routes/openai.rs`

**ä»»åŠ¡æ¸…å•**:
- [ ] åœ¨ `handle_messages` éæµå¼å“åº”ä¸­é›†æˆ PricingService
  - æ›¿æ¢ `cost: 0.0` ä¸ºçœŸå®æˆæœ¬è®¡ç®—
  - è°ƒç”¨ `pricing_service.calculate_cost()`
  - è®°å½•è¯¦ç»†çš„æˆæœ¬åˆ†è§£ï¼ˆinput/output/cacheï¼‰
- [ ] åœ¨æµå¼å“åº”ä¸­é›†æˆæˆæœ¬è®¡ç®—
  - ä» SSE æµä¸­æ•è· usage æ•°æ®åè®¡ç®—æˆæœ¬
  - å¼‚æ­¥è®°å½•æˆæœ¬ç»Ÿè®¡
- [ ] ä¸º Gemini å’Œ OpenAI è·¯ç”±æ·»åŠ æˆæœ¬è®¡ç®—
- [ ] æµ‹è¯•æˆæœ¬è®¡ç®—å‡†ç¡®æ€§

**å®ç°ç¤ºä¾‹**:
```rust
// æ›¿æ¢å‰
let cost = 0.0; // TODO: å®é™…æˆæœ¬è®¡ç®—

// æ›¿æ¢å
let cost_result = state.pricing_service
    .calculate_cost(
        &model,
        usage.input_tokens,
        usage.output_tokens,
        usage.cache_creation_input_tokens,
        usage.cache_read_input_tokens,
        usage.cache_creation.as_ref(),
    )
    .await?;

let cost = cost_result.total_cost;
```

#### 1.2 å¤šç»´åº¦ç»Ÿè®¡ (P1)
**é¢„æœŸæ—¶é—´**: 1 å¤©
**æ–‡ä»¶**: æ–°å»º `src/services/usage_stats.rs`

**ä»»åŠ¡æ¸…å•**:
- [ ] åˆ›å»º UsageStatsService
  - æŒ‰æ—¶é—´ç»´åº¦ç»Ÿè®¡ï¼ˆå°æ—¶/å¤©/æœˆï¼‰
  - æŒ‰æ¨¡å‹ç»´åº¦ç»Ÿè®¡
  - æŒ‰ç”¨æˆ·ç»´åº¦ç»Ÿè®¡
  - æŒ‰è´¦æˆ·ç»´åº¦ç»Ÿè®¡
- [ ] å®ç°ç»Ÿè®¡èšåˆ
  - æ€» tokens ä½¿ç”¨é‡
  - æ€»æˆæœ¬
  - è¯·æ±‚æ•°é‡
  - æˆåŠŸ/å¤±è´¥ç‡
- [ ] Redis æ•°æ®ç»“æ„è®¾è®¡
  - `usage:hourly:{date}:{hour}:{key}` - å°æ—¶ç»Ÿè®¡
  - `usage:daily:{date}:{key}` - æ—¥ç»Ÿè®¡
  - `usage:model:{model}:{date}` - æ¨¡å‹ç»Ÿè®¡
  - `usage:global:{date}` - å…¨å±€ç»Ÿè®¡
- [ ] ç¼–å†™é›†æˆæµ‹è¯•

**æ•°æ®ç»“æ„**:
```rust
pub struct UsageStats {
    pub period: StatsPeriod,
    pub total_requests: i64,
    pub total_input_tokens: i64,
    pub total_output_tokens: i64,
    pub total_cache_creation_tokens: i64,
    pub total_cache_read_tokens: i64,
    pub total_cost: f64,
    pub success_count: i64,
    pub error_count: i64,
    pub models: HashMap<String, ModelStats>,
}
```

#### 1.3 å®æ—¶æŒ‡æ ‡æ”¶é›† (P2)
**é¢„æœŸæ—¶é—´**: 1 å¤©
**æ–‡ä»¶**: æ–°å»º `src/services/metrics.rs`

**ä»»åŠ¡æ¸…å•**:
- [ ] åˆ›å»º MetricsService
  - æ»‘åŠ¨çª—å£ç»Ÿè®¡ï¼ˆæœ€è¿‘ 5/15/60 åˆ†é’Ÿï¼‰
  - å®æ—¶è¯·æ±‚é€Ÿç‡
  - å¹³å‡å“åº”æ—¶é—´
  - é”™è¯¯ç‡ç›‘æ§
- [ ] å®ç°æŒ‡æ ‡èšåˆ
  - P50/P90/P99 å»¶è¿Ÿ
  - è¯·æ±‚ååé‡
  - å¹¶å‘æ•°ç»Ÿè®¡
- [ ] æš´éœ² Prometheus æ ¼å¼ï¼ˆå¯é€‰ï¼‰
- [ ] ç¼–å†™æ€§èƒ½æµ‹è¯•

**æŒ‡æ ‡ç±»å‹**:
```rust
pub struct RealtimeMetrics {
    pub window_minutes: i64,
    pub request_rate: f64,          // è¯·æ±‚/ç§’
    pub avg_latency_ms: f64,        // å¹³å‡å»¶è¿Ÿ
    pub p50_latency_ms: f64,        // P50 å»¶è¿Ÿ
    pub p90_latency_ms: f64,        // P90 å»¶è¿Ÿ
    pub p99_latency_ms: f64,        // P99 å»¶è¿Ÿ
    pub error_rate: f64,            // é”™è¯¯ç‡
    pub active_sessions: i64,       // æ´»è·ƒä¼šè¯æ•°
    pub concurrent_requests: i64,   // å¹¶å‘è¯·æ±‚æ•°
}
```

---

## ğŸš¦ Phase 7.2: é€Ÿç‡é™åˆ¶å®ç°

### å½“å‰çŠ¶æ€åˆ†æ

**å·²å­˜åœ¨çš„åŸºç¡€è®¾æ–½**:
- âœ… `src/services/api_key.rs::check_rate_limit()` - é€Ÿç‡é™åˆ¶æ£€æŸ¥é€»è¾‘
  - æ»‘åŠ¨çª—å£ç®—æ³•
  - Redis è®¡æ•°å™¨
  - çª—å£é‡ç½®é€»è¾‘
- âœ… API Key æ•°æ®æ¨¡å‹æ”¯æŒ
  - `rate_limit_window` - é™æµçª—å£ï¼ˆç§’ï¼‰
  - `rate_limit_requests` - æœ€å¤§è¯·æ±‚æ•°
  - `rate_limit_cost` - æˆæœ¬é™åˆ¶

**å¾…å®Œå–„åŠŸèƒ½**:

#### 2.1 é€Ÿç‡é™åˆ¶æ‰§è¡Œ (P0)
**é¢„æœŸæ—¶é—´**: 0.5 å¤©
**æ–‡ä»¶**: `src/middleware/auth.rs`, `src/routes/*.rs`

**ä»»åŠ¡æ¸…å•**:
- [ ] åœ¨è®¤è¯ä¸­é—´ä»¶ä¸­è°ƒç”¨ `check_rate_limit()`
  - éªŒè¯åè‡ªåŠ¨æ£€æŸ¥é€Ÿç‡é™åˆ¶
  - é™æµè¶…å‡ºæ—¶è¿”å› 429 çŠ¶æ€ç 
  - è®¾ç½® Retry-After å“åº”å¤´
- [ ] åœ¨è·¯ç”±å¤„ç†å™¨ä¸­è®°å½•è¯·æ±‚è®¡æ•°
  - è¯·æ±‚å¼€å§‹æ—¶å¢åŠ è®¡æ•°
  - è¯·æ±‚å¤±è´¥æ—¶å›æ»šè®¡æ•°ï¼ˆå¯é€‰ï¼‰
- [ ] æ·»åŠ é€Ÿç‡é™åˆ¶å“åº”æ ¼å¼
  - æ ‡å‡†é”™è¯¯æ¶ˆæ¯
  - å‰©ä½™é…é¢ä¿¡æ¯
  - é‡ç½®æ—¶é—´ä¿¡æ¯
- [ ] ç¼–å†™é™æµæµ‹è¯•

**å®ç°ç¤ºä¾‹**:
```rust
// åœ¨ authenticate_api_key ä¸­é—´ä»¶ä¸­
let api_key = service.get_api_key(&key_value).await?;

// æ£€æŸ¥é€Ÿç‡é™åˆ¶
service.check_rate_limit(&api_key).await
    .map_err(|e| AppError::RateLimitExceeded(e.to_string()))?;

// ç»§ç»­å¤„ç†è¯·æ±‚...
```

**é”™è¯¯å“åº”**:
```json
{
  "error": {
    "type": "rate_limit_exceeded",
    "message": "è¯·æ±‚é€Ÿç‡è¶…å‡ºé™åˆ¶",
    "limit": 100,
    "window": 3600,
    "retry_after": 1234
  }
}
```

#### 2.2 æˆæœ¬é™åˆ¶å®ç° (P1)
**é¢„æœŸæ—¶é—´**: 0.5 å¤©
**æ–‡ä»¶**: `src/services/api_key.rs`

**ä»»åŠ¡æ¸…å•**:
- [ ] å®ç° `check_cost_limit()` æ–¹æ³•
  - æŸ¥è¯¢å½“å‰å‘¨æœŸæ€»æˆæœ¬
  - ä¸ `rate_limit_cost` å¯¹æ¯”
  - è¶…å‡ºæ—¶æ‹’ç»è¯·æ±‚
- [ ] åœ¨è¯·æ±‚å¤„ç†åè®°å½•æˆæœ¬
  - å¼‚æ­¥æ›´æ–°æˆæœ¬è®¡æ•°
  - çª—å£è¿‡æœŸè‡ªåŠ¨é‡ç½®
- [ ] æ·»åŠ æˆæœ¬è¶…é™å“åº”
- [ ] ç¼–å†™æˆæœ¬é™åˆ¶æµ‹è¯•

**å®ç°ç¤ºä¾‹**:
```rust
pub async fn check_cost_limit(&self, api_key: &ApiKey) -> Result<()> {
    if let Some(max_cost) = api_key.rate_limit_cost {
        let current_cost = self.get_period_cost(&api_key.id).await?;

        if current_cost >= max_cost {
            return Err(anyhow!("æˆæœ¬é™åˆ¶å·²è¾¾ä¸Šé™"));
        }
    }

    Ok(())
}
```

#### 2.3 å¹¶å‘æ§åˆ¶ä¼˜åŒ– (P2)
**é¢„æœŸæ—¶é—´**: 1 å¤©
**æ–‡ä»¶**: `src/services/account_scheduler.rs`

**ä»»åŠ¡æ¸…å•**:
- [ ] ä¼˜åŒ–å¹¶å‘è®¡æ•°æ¸…ç†
  - å½“å‰æ¯åˆ†é’Ÿæ¸…ç†ä¸€æ¬¡
  - æ”¹ä¸ºåŸºäº TTL çš„è‡ªåŠ¨è¿‡æœŸ
  - å‡å°‘ Redis æ‰«æå¼€é”€
- [ ] æ·»åŠ å¹¶å‘ç›‘æ§
  - å®æ—¶å¹¶å‘æ•°æŸ¥è¯¢
  - å¹¶å‘å³°å€¼è®°å½•
  - å¹¶å‘é™åˆ¶å‘Šè­¦
- [ ] å®ç°å¹¶å‘é˜Ÿåˆ—ï¼ˆå¯é€‰ï¼‰
  - è¶…å‡ºå¹¶å‘é™åˆ¶æ—¶æ’é˜Ÿç­‰å¾…
  - é…ç½®æœ€å¤§ç­‰å¾…æ—¶é—´
  - é˜Ÿåˆ—æº¢å‡ºæ‹’ç»
- [ ] æ€§èƒ½æµ‹è¯•å’ŒåŸºå‡†æµ‹è¯•

---

## ğŸ”§ Phase 7.3: OpenAI è½¬å‘æœåŠ¡å®Œå–„

### å½“å‰çŠ¶æ€åˆ†æ

**å·²å­˜åœ¨çš„åŸºç¡€**:
- âœ… `src/routes/openai.rs` - è·¯ç”±å±‚å®Œæˆ
- âœ… `src/services/unified_openai_scheduler.rs` - è°ƒåº¦å™¨å®Œæˆ
- â³ `src/services/openai_relay.rs` - éƒ¨åˆ†å®ç°

**å¾…å®Œå–„åŠŸèƒ½**:

#### 3.1 OpenAI Responses è½¬å‘é€»è¾‘ (P1)
**é¢„æœŸæ—¶é—´**: 1 å¤©
**æ–‡ä»¶**: `src/services/openai_relay.rs`, `src/routes/openai.rs`

**ä»»åŠ¡æ¸…å•**:
- [ ] å®ç° OpenAI Responses è¯·æ±‚æ ¼å¼è½¬æ¢
  - ä» Responses æ ¼å¼è½¬ä¸ºå†…éƒ¨æ ¼å¼
  - å¤„ç† prompt å­—æ®µ
  - å¤„ç†æ¨¡å‹å‚æ•°
- [ ] å®ç°è½¬å‘æ ¸å¿ƒé€»è¾‘
  - HTTP è¯·æ±‚æ„å»º
  - è®¤è¯å¤´è®¾ç½®
  - ä»£ç†æ”¯æŒ
- [ ] å®ç°å“åº”æ ¼å¼è½¬æ¢
  - å†…éƒ¨æ ¼å¼è½¬ä¸º Responses æ ¼å¼
  - choices æ•°ç»„æ„å»º
  - usage æ•°æ®æ˜ å°„
- [ ] é”™è¯¯å¤„ç†å’Œé‡è¯•
  - ç½‘ç»œé”™è¯¯é‡è¯•
  - è¶…æ—¶å¤„ç†
  - 429 é”™è¯¯å¤„ç†
- [ ] ç¼–å†™è½¬å‘æµ‹è¯•

**æ ¸å¿ƒæ–¹æ³•**:
```rust
pub async fn relay_responses_request(
    &self,
    account: &Account,
    request: &JsonValue,
) -> Result<JsonValue> {
    // 1. æ„å»ºè¯·æ±‚
    let req = self.build_openai_request(account, request)?;

    // 2. å‘é€è¯·æ±‚
    let resp = self.http_client
        .post(&account.api_endpoint)
        .header("Authorization", format!("Bearer {}", account.api_key))
        .json(&req)
        .send()
        .await?;

    // 3. è§£æå“åº”
    let response_data: JsonValue = resp.json().await?;

    // 4. æ ¼å¼è½¬æ¢
    self.convert_to_responses_format(&response_data)
}
```

#### 3.2 æµå¼å“åº”æ”¯æŒ (P2)
**é¢„æœŸæ—¶é—´**: 1 å¤©
**æ–‡ä»¶**: `src/services/openai_relay.rs`, `src/routes/openai.rs`

**ä»»åŠ¡æ¸…å•**:
- [ ] å®ç°æµå¼è¯·æ±‚è½¬å‘
  - SSE æµå»ºç«‹
  - åˆ†å—è¯»å–
  - äº‹ä»¶è§£æ
- [ ] å®ç°æµå¼å“åº”ç”Ÿæˆ
  - è½¬æ¢ä¸º Responses SSE æ ¼å¼
  - delta æ•°æ®æ„å»º
  - ç»“æŸäº‹ä»¶å¤„ç†
- [ ] Usage æ•°æ®æ•è·
  - ä»æµä¸­æå– usage
  - å¼‚æ­¥è®°å½•ç»Ÿè®¡
  - æˆæœ¬è®¡ç®—
- [ ] ç¼–å†™æµå¼æµ‹è¯•

#### 3.3 è§£é™¤ ignored æµ‹è¯• (P1)
**é¢„æœŸæ—¶é—´**: 0.5 å¤©
**æ–‡ä»¶**: `tests/openai_routes_integration_test.rs`

**ä»»åŠ¡æ¸…å•**:
- [ ] è§£é™¤ `test_all_permission_accepts_openai` çš„ ignore
- [ ] è§£é™¤ `test_responses_endpoint` çš„ ignore
- [ ] è§£é™¤ `test_v1_responses_endpoint` çš„ ignore
- [ ] ç¡®ä¿æ‰€æœ‰æµ‹è¯•é€šè¿‡

---

## ğŸ“‹ å®æ–½è®¡åˆ’

### Week 1: ç»Ÿè®¡å’Œé™æµæ ¸å¿ƒ

**Day 1-2: æˆæœ¬è®¡ç®—é›†æˆ**
- âœ… é›†æˆ PricingService åˆ°æ‰€æœ‰è·¯ç”±
- âœ… æ›¿æ¢æ‰€æœ‰ `cost: 0.0` ä¸ºçœŸå®è®¡ç®—
- âœ… æµ‹è¯•æˆæœ¬è®¡ç®—å‡†ç¡®æ€§

**Day 3-4: é€Ÿç‡é™åˆ¶æ‰§è¡Œ**
- âœ… åœ¨ä¸­é—´ä»¶ä¸­å¯ç”¨é™æµæ£€æŸ¥
- âœ… å®ç°æˆæœ¬é™åˆ¶
- âœ… æ·»åŠ é™æµå“åº”æ ¼å¼
- âœ… ç¼–å†™é™æµæµ‹è¯•

**Day 5: å¤šç»´åº¦ç»Ÿè®¡**
- âœ… åˆ›å»º UsageStatsService
- âœ… å®ç°ç»Ÿè®¡èšåˆ
- âœ… è®¾è®¡ Redis æ•°æ®ç»“æ„

### Week 2: OpenAI å®Œå–„å’Œä¼˜åŒ–

**Day 1-2: OpenAI è½¬å‘å®ç°**
- âœ… å®Œæˆ Responses è½¬å‘é€»è¾‘
- âœ… å®ç°æµå¼å“åº”æ”¯æŒ
- âœ… è§£é™¤ ignored æµ‹è¯•

**Day 3: å®æ—¶æŒ‡æ ‡æ”¶é›†**
- âœ… åˆ›å»º MetricsService
- âœ… å®ç°æŒ‡æ ‡èšåˆ
- âœ… æ€§èƒ½æµ‹è¯•

**Day 4-5: ä¼˜åŒ–å’Œæµ‹è¯•**
- âœ… å¹¶å‘æ§åˆ¶ä¼˜åŒ–
- âœ… æ€§èƒ½åŸºå‡†æµ‹è¯•
- âœ… æ–‡æ¡£æ›´æ–°

---

## ğŸ¯ æˆåŠŸæ ‡å‡†

### åŠŸèƒ½å®Œæ•´æ€§
- âœ… æ‰€æœ‰è·¯ç”±é›†æˆçœŸå®æˆæœ¬è®¡ç®—
- âœ… é€Ÿç‡é™åˆ¶çœŸå®æ‰§è¡Œå¹¶è¿”å› 429
- âœ… æˆæœ¬é™åˆ¶çœŸå®æ‰§è¡Œ
- âœ… å¤šç»´åº¦ç»Ÿè®¡æ•°æ®å¯æŸ¥è¯¢
- âœ… OpenAI è½¬å‘é€»è¾‘å®Œæ•´
- âœ… æ‰€æœ‰ ignored æµ‹è¯•è§£é™¤

### æµ‹è¯•è¦†ç›–
- âœ… æˆæœ¬è®¡ç®—æµ‹è¯• (å·²æœ‰ 23 ä¸ª)
- âœ… é€Ÿç‡é™åˆ¶æµ‹è¯• (æ–°å¢ 5+)
- âœ… æˆæœ¬é™åˆ¶æµ‹è¯• (æ–°å¢ 3+)
- âœ… ç»Ÿè®¡æœåŠ¡æµ‹è¯• (æ–°å¢ 10+)
- âœ… OpenAI è½¬å‘æµ‹è¯• (è§£é™¤ 3 ä¸ª ignored)
- **ç›®æ ‡**: 280+ ä¸ªæµ‹è¯•é€šè¿‡

### æ€§èƒ½æŒ‡æ ‡
- âœ… æˆæœ¬è®¡ç®—å»¶è¿Ÿ < 1ms
- âœ… é€Ÿç‡é™åˆ¶æ£€æŸ¥å»¶è¿Ÿ < 5ms
- âœ… ç»Ÿè®¡æŸ¥è¯¢å»¶è¿Ÿ < 10ms
- âœ… å¹¶å‘è¯·æ±‚å¤„ç† > 10,000/s
- âœ… å†…å­˜ä½¿ç”¨ < 100MB

### æ–‡æ¡£è´¨é‡
- âœ… API æ–‡æ¡£æ›´æ–°
- âœ… é…ç½®æ–‡æ¡£æ›´æ–°
- âœ… è¿ç»´æ‰‹å†Œæ›´æ–°
- âœ… Phase 7 å®ŒæˆæŠ¥å‘Š

---

## ğŸ“Š é¢„æœŸæˆæœ

### ä»£ç å¢é‡
- **æ–°å¢æ–‡ä»¶**: 2-3 ä¸ª (usage_stats.rs, metrics.rs)
- **ä¿®æ”¹æ–‡ä»¶**: 10+ ä¸ª (æ‰€æœ‰è·¯ç”±ã€ä¸­é—´ä»¶ã€æœåŠ¡)
- **æ–°å¢ä»£ç **: ~1,500 è¡Œ
- **æ–°å¢æµ‹è¯•**: ~500 è¡Œ

### æµ‹è¯•å¢é‡
- **æ–°å¢å•å…ƒæµ‹è¯•**: 15+
- **æ–°å¢é›†æˆæµ‹è¯•**: 20+
- **æ€»æµ‹è¯•æ•°**: 280 â†’ 315+

### åŠŸèƒ½å¢å¼º
- âœ… çœŸå®æˆæœ¬è®¡ç®—å’Œè¿½è¸ª
- âœ… ç”Ÿäº§çº§é€Ÿç‡é™åˆ¶
- âœ… å¤šç»´åº¦ä½¿ç”¨ç»Ÿè®¡
- âœ… å®æ—¶ç›‘æ§æŒ‡æ ‡
- âœ… OpenAI å®Œæ•´æ”¯æŒ

---

## ğŸ”— ä¾èµ–å’Œé›†æˆ

### å·²æœ‰ä¾èµ–
- âœ… PricingService (å®šä»·æœåŠ¡)
- âœ… CostCalculator (æˆæœ¬è®¡ç®—å™¨)
- âœ… ApiKeyService (API Key æœåŠ¡)
- âœ… Redis (æ•°æ®å­˜å‚¨)

### æ–°å¢ä¾èµ–
- æ— éœ€æ–°å¢å¤–éƒ¨ä¾èµ–
- å¤ç”¨ç°æœ‰ Tokio/Redis/Axum æ ˆ

### é›†æˆç‚¹
1. **è·¯ç”±å±‚** â†’ PricingService (æˆæœ¬è®¡ç®—)
2. **ä¸­é—´ä»¶** â†’ ApiKeyService (é€Ÿç‡é™åˆ¶)
3. **è½¬å‘æœåŠ¡** â†’ UsageStatsService (ç»Ÿè®¡è®°å½•)
4. **è°ƒåº¦å™¨** â†’ MetricsService (ç›‘æ§æŒ‡æ ‡)

---

## ğŸš¨ é£é™©å’Œç¼“è§£

### æŠ€æœ¯é£é™©

**é£é™© 1: æˆæœ¬è®¡ç®—æ€§èƒ½å½±å“**
- **æè¿°**: æ¯ä¸ªè¯·æ±‚éƒ½è®¡ç®—æˆæœ¬å¯èƒ½å¢åŠ å»¶è¿Ÿ
- **ç¼“è§£**: ä½¿ç”¨å¼‚æ­¥æˆæœ¬è®°å½•ï¼Œä¸»æµç¨‹ä¸é˜»å¡
- **å¤‡é€‰**: LRU ç¼“å­˜å®šä»·æ•°æ®ï¼ˆå·²å®ç°ï¼‰

**é£é™© 2: é€Ÿç‡é™åˆ¶ Redis è´Ÿè½½**
- **æè¿°**: é«˜é¢‘ç‡æ£€æŸ¥å¯èƒ½å¢åŠ  Redis å‹åŠ›
- **ç¼“è§£**: ä½¿ç”¨ Redis ç®¡é“æ‰¹é‡æ“ä½œ
- **å¤‡é€‰**: æœ¬åœ°ç¼“å­˜ + Redis åŒæ­¥

**é£é™© 3: ç»Ÿè®¡æ•°æ®é‡å¢é•¿**
- **æè¿°**: é•¿æœŸè¿è¡Œç»Ÿè®¡æ•°æ®è¿‡å¤§
- **ç¼“è§£**: å®ç°æ•°æ®å½’æ¡£å’Œæ¸…ç†
- **å¤‡é€‰**: åªä¿ç•™æœ€è¿‘ N å¤©æ•°æ®

### æ—¶é—´é£é™©

**é£é™© 1: OpenAI è½¬å‘å¤æ‚åº¦**
- **é¢„æœŸæ—¶é—´**: 2 å¤©
- **å®é™…å¯èƒ½**: 3-4 å¤©ï¼ˆæ ¼å¼è½¬æ¢å¤æ‚ï¼‰
- **ç¼“è§£**: é™ä½ä¼˜å…ˆçº§ï¼Œå¯æ”¾åˆ° Phase 8

**é£é™© 2: æµ‹è¯•è¦†ç›–ä¸è¶³**
- **é¢„æœŸ**: 100% æ–°åŠŸèƒ½æµ‹è¯•
- **å®é™…å¯èƒ½**: 80-90%
- **ç¼“è§£**: ä¼˜å…ˆæ ¸å¿ƒåŠŸèƒ½æµ‹è¯•ï¼Œè¾¹ç¼˜æƒ…å†µåç»­è¡¥å……

---

## ğŸ“– å‚è€ƒæ–‡æ¡£

### Node.js å‚è€ƒå®ç°
- `src/services/apiKeyService.js` - é€Ÿç‡é™åˆ¶å®ç°
- `src/services/pricingService.js` - å®šä»·æœåŠ¡
- `src/services/openaiResponsesRelayService.js` - OpenAI è½¬å‘

### å†…éƒ¨æ–‡æ¡£
- `docs/INTERFACE.md` - API æ¥å£è§„èŒƒ
- `rust/TODO.md` - ä»»åŠ¡æ¸…å•
- `rust/PHASE6_COMPLETE_FINAL.md` - Phase 6 å®ŒæˆæŠ¥å‘Š

### æµ‹è¯•å‚è€ƒ
- `tests/pricing_service_integration_test.rs` - å®šä»·æµ‹è¯•
- `tests/api_key_advanced_integration_test.rs` - API Key æµ‹è¯•
- `tests/cost_integration_test.rs` - æˆæœ¬æµ‹è¯•

---

## âœ… ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³å¼€å§‹ (Day 1)
1. **æˆæœ¬è®¡ç®—é›†æˆ** - æœ€é«˜ä¼˜å…ˆçº§
   - ä¿®æ”¹ `src/routes/api.rs::handle_messages` éæµå¼å“åº”
   - æ›¿æ¢ `cost: 0.0` ä¸º `pricing_service.calculate_cost()`
   - éªŒè¯æˆæœ¬è®¡ç®—æ­£ç¡®æ€§

2. **é€Ÿç‡é™åˆ¶æ‰§è¡Œ** - é«˜ä¼˜å…ˆçº§
   - ä¿®æ”¹ `src/middleware/auth.rs::authenticate_api_key`
   - æ·»åŠ  `check_rate_limit()` è°ƒç”¨
   - æ·»åŠ  429 é”™è¯¯å“åº”

3. **ç¼–å†™æµ‹è¯•** - åŒæ­¥è¿›è¡Œ
   - æˆæœ¬è®¡ç®—é›†æˆæµ‹è¯•
   - é€Ÿç‡é™åˆ¶é›†æˆæµ‹è¯•
   - ç¡®ä¿ 100% é€šè¿‡

### æœ¬å‘¨ç›®æ ‡
- âœ… Phase 7.1 å®Œæˆï¼ˆç»Ÿè®¡æœåŠ¡ï¼‰
- âœ… Phase 7.2 å®Œæˆï¼ˆé€Ÿç‡é™åˆ¶ï¼‰
- ğŸ”„ Phase 7.3 å¼€å§‹ï¼ˆOpenAI è½¬å‘ï¼‰

### ä¸‹å‘¨ç›®æ ‡
- âœ… Phase 7.3 å®Œæˆ
- âœ… æ€§èƒ½æµ‹è¯•å’Œä¼˜åŒ–
- âœ… æ–‡æ¡£æ›´æ–°
- âœ… Phase 7 å®ŒæˆæŠ¥å‘Š

---

**æ–‡æ¡£åˆ›å»ºè€…**: Rust Migration Team
**å½“å‰çŠ¶æ€**: Phase 6 å®Œæˆ âœ…, Phase 7 è§„åˆ’å®Œæˆ ğŸ“‹
**å»ºè®®**: ç«‹å³å¼€å§‹ Phase 7.1 (æˆæœ¬è®¡ç®—é›†æˆ)

**æ›´æ–°é¢‘ç‡**: æ¯å®Œæˆä¸€ä¸ªå­é˜¶æ®µæ›´æ–°
**ä¸‹æ¬¡æ›´æ–°**: Phase 7.1 å®Œæˆå
